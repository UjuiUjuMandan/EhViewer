From 4e0c42c955161687a8cc9e0b0690ffbcc7a98189 Mon Sep 17 00:00:00 2001
From: FooIbar <118464521+FooIbar@users.noreply.github.com>
Date: Sun, 16 Nov 2025 21:38:58 +0800
Subject: [PATCH] Use `-ffile-prefix-map` to improve reproducibility

---
 app/src/main/cpp/CMakeLists.txt | 23 +++++++++++++----------
 1 file changed, 13 insertions(+), 10 deletions(-)

diff --git a/app/src/main/cpp/CMakeLists.txt b/app/src/main/cpp/CMakeLists.txt
index 7a73ecdc7..72a868c12 100644
--- a/app/src/main/cpp/CMakeLists.txt
+++ b/app/src/main/cpp/CMakeLists.txt
@@ -5,16 +5,19 @@ include(FetchContent)
 
 if (NOT CMAKE_BUILD_TYPE STREQUAL "Debug")
     string(CONCAT CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -O3 -ffast-math -fvisibility=hidden -fvisibility-inlines-hidden -funroll-loops -flto "
-           "-mllvm -polly "
-           "-mllvm -polly-run-dce "
-           "-mllvm -polly-run-inliner "
-           "-mllvm -polly-isl-arg=--no-schedule-serialize-sccs "
-           "-mllvm -polly-ast-use-context "
-           "-mllvm -polly-detect-keep-going "
-           "-mllvm -polly-position=before-vectorizer "
-           "-mllvm -polly-vectorizer=stripmine "
-           "-mllvm -polly-detect-profitability-min-per-loop-insts=40 "
-           "-mllvm -polly-invariant-load-hoisting")
+            "-ffile-prefix-map=${ANDROID_TOOLCHAIN_ROOT}= "
+            "-ffile-prefix-map=${CMAKE_SOURCE_DIR}= "
+            "-ffile-prefix-map=${CMAKE_BINARY_DIR}= "
+            "-mllvm -polly "
+            "-mllvm -polly-run-dce "
+            "-mllvm -polly-run-inliner "
+            "-mllvm -polly-isl-arg=--no-schedule-serialize-sccs "
+            "-mllvm -polly-ast-use-context "
+            "-mllvm -polly-detect-keep-going "
+            "-mllvm -polly-position=before-vectorizer "
+            "-mllvm -polly-vectorizer=stripmine "
+            "-mllvm -polly-detect-profitability-min-per-loop-insts=40 "
+            "-mllvm -polly-invariant-load-hoisting")
 endif (NOT CMAKE_BUILD_TYPE STREQUAL "Debug")
 
 option(BUILD_TESTING OFF)
